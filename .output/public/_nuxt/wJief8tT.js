import{u as X,f as m,i as L,e as Z,j as ee,k as ae,l as G,m as te,r as y,n as B,o as w,a as r,w as o,d as p,t as v,b as g,c as D,g as V,p as le,h as C,q as ne,s as re}from"./CRyLGsn1.js";import{u as oe}from"./DB0gNfsU.js";import{_ as se}from"./DlAUqK2U.js";const ie=()=>{const{$api:b}=X(),i=m(!1),s=m(null),k=async a=>{try{return await a.getIdToken()}catch(t){throw console.error("Failed to get Firebase ID token:",t),new Error("Authentication failed. Please sign in again.")}},K=async a=>({Authorization:`Bearer ${await k(a)}`,"Content-Type":"application/json"}),I=async(a,t)=>{var c,l;i.value=!0,s.value=null;try{const u=await K(a);return(await b.post("/api/user/api-key",{apiKey:t.trim()},{headers:u})).data}catch(u){const d=((l=(c=u.response)==null?void 0:c.data)==null?void 0:l.error)||"Failed to link API key";throw s.value=d,new Error(d)}finally{i.value=!1}},M=async a=>{var t,c;i.value=!0,s.value=null;try{const l=await K(a);return(await b.get("/api/user/api-key",{headers:l})).data}catch(l){const u=((c=(t=l.response)==null?void 0:t.data)==null?void 0:c.error)||"Failed to get API key";throw s.value=u,new Error(u)}finally{i.value=!1}},x=async a=>{var t,c;i.value=!0,s.value=null;try{const l=await K(a);return(await b.get("/api/user/api-key?full=true",{headers:l})).data}catch(l){const u=((c=(t=l.response)==null?void 0:t.data)==null?void 0:c.error)||"Failed to get API key";throw s.value=u,new Error(u)}finally{i.value=!1}},$=async a=>{var t,c;i.value=!0,s.value=null;try{const l=await K(a);return(await b.delete("/api/user/api-key",{headers:l})).data}catch(l){const u=((c=(t=l.response)==null?void 0:t.data)==null?void 0:c.error)||"Failed to remove API key";throw s.value=u,new Error(u)}finally{i.value=!1}},P=a=>{if(!a||typeof a!="string")return{isValid:!1,error:"API key is required"};const t=a.trim();return t.length<20?{isValid:!1,error:"API key must be at least 20 characters long"}:t.length>200?{isValid:!1,error:"API key is too long (maximum 200 characters)"}:{isValid:!0}},F=a=>a?!0:(s.value="You must be signed in to manage API keys",!1);return{loading:L(i),error:L(s),linkApiKey:I,getUserApiKey:M,getFullApiKey:x,removeApiKey:$,validateApiKey:P,checkAuthentication:F}},ue={class:"mb-4 text-body-2"},ce={key:2,class:"mb-4"},de={class:"d-flex align-center justify-space-between"},ve={class:"text-subtitle-2 mb-1"},pe={class:"text-body-2 font-mono"},ye={class:"text-caption text-medium-emphasis"},fe={class:"d-flex flex-column gap-2"},me={key:3},_e=Z({__name:"ApiKeyManager",setup(b){const{t:i}=ee(),{user:s}=ae(),{loading:k,error:K,linkApiKey:I,getUserApiKey:M,removeApiKey:x}=ie(),{isApiKeyManagerOpen:$,closeApiKeyManager:P}=re(),{setApiKeyValue:F}=oe(),a=m(!1),t=m(!1),c=m(""),l=m(null),u=m(),d=m(null),_=m(null),H=[e=>!!e||i("apiKey.validation.required"),e=>e.length>=20||i("apiKey.validation.invalid")],O=e=>new Date(e).toLocaleDateString(),E=async()=>{if(s.value)try{const e=await M(s.value);e.hasKey&&(l.value={apiKey:e.apiKey,linkedAt:e.lastSaved},F(!0))}catch(e){console.error("Error loading API key:",e)}},N=async()=>{var n;if(!s.value){d.value=i("auth.error.notAuthenticated");return}const{valid:e}=await((n=u.value)==null?void 0:n.validate());if(e)try{d.value=null,_.value=null;const h=await I(s.value,c.value);h.success?(_.value=i("apiKey.success"),c.value="",t.value=!1,await E()):d.value=h.error||i("apiKey.error")}catch(h){d.value=h.message||i("apiKey.error")}},Y=async()=>{if(s.value)try{d.value=null,_.value=null;const e=await x(s.value);e.success?(_.value=e.message,l.value=null,a.value=!1):d.value=e.error||i("apiKey.error")}catch(e){d.value=e.message||i("apiKey.error")}},J=()=>{P(),t.value=!1,c.value="",d.value=null,_.value=null,a.value=!1};return G(s,async e=>{e?await E():l.value=null},{immediate:!0}),G(K,e=>{e&&(d.value=e)}),te(async()=>{s.value&&await E()}),(e,n)=>{const h=y("v-icon"),S=y("v-card-title"),U=y("v-alert"),A=y("v-btn"),R=y("v-card"),Q=y("v-text-field"),W=y("v-form"),q=y("v-card-text"),T=y("v-spacer"),j=y("v-card-actions"),z=y("v-dialog");return w(),B("div",null,[r(z,{modelValue:C($),"onUpdate:modelValue":n[5]||(n[5]=f=>ne($)?$.value=f:null),"max-width":"600px",persistent:""},{default:o(()=>[r(R,null,{default:o(()=>[r(S,{class:"d-flex align-center"},{default:o(()=>[r(h,{class:"mr-2",color:"primary"},{default:o(()=>n[8]||(n[8]=[p("mdi-key-variant")])),_:1,__:[8]}),p(" "+v(e.$t("apiKey.title")),1)]),_:1}),r(q,null,{default:o(()=>[g("p",ue,v(e.$t("apiKey.description")),1),d.value?(w(),D(U,{key:0,type:"error",variant:"tonal",class:"mb-4",closable:"","onClick:close":n[0]||(n[0]=f=>d.value=null)},{default:o(()=>[p(v(d.value),1)]),_:1})):V("",!0),_.value?(w(),D(U,{key:1,type:"success",variant:"tonal",class:"mb-4",closable:"","onClick:close":n[1]||(n[1]=f=>_.value=null)},{default:o(()=>[p(v(_.value),1)]),_:1})):V("",!0),l.value&&!t.value?(w(),B("div",ce,[r(R,{variant:"outlined",class:"pa-3"},{default:o(()=>[g("div",de,[g("div",null,[g("div",ve,v(e.$t("apiKey.current")),1),g("div",pe,v(l.value.apiKey),1),g("div",ye,v(e.$t("auth.linkedAt"))+": "+v(O(l.value.linkedAt)),1)]),g("div",fe,[r(A,{size:"small",color:"primary",variant:"outlined",onClick:n[2]||(n[2]=f=>t.value=!0)},{default:o(()=>[p(v(e.$t("apiKey.update")),1)]),_:1}),r(A,{size:"small",color:"error",variant:"outlined",onClick:n[3]||(n[3]=f=>a.value=!0)},{default:o(()=>[p(v(e.$t("apiKey.remove")),1)]),_:1})])])]),_:1})])):V("",!0),!l.value||t.value?(w(),B("div",me,[r(W,{ref_key:"formRef",ref:u,onSubmit:le(N,["prevent"])},{default:o(()=>[r(Q,{modelValue:c.value,"onUpdate:modelValue":n[4]||(n[4]=f=>c.value=f),label:e.$t("apiKey.inputLabel"),placeholder:e.$t("apiKey.inputPlaceholder"),variant:"outlined",type:"password","prepend-inner-icon":"mdi-key",rules:H,loading:C(k),class:"mb-3",required:""},null,8,["modelValue","label","placeholder","loading"])]),_:1},512)])):V("",!0)]),_:1}),r(j,{class:"pa-4"},{default:o(()=>[r(T),r(A,{variant:"text",onClick:J,disabled:C(k)},{default:o(()=>[p(v(e.$t("apiKey.cancel")),1)]),_:1},8,["disabled"]),!l.value||t.value?(w(),D(A,{key:0,color:"primary",variant:"flat",loading:C(k),onClick:N},{default:o(()=>[p(v(e.$t("apiKey.save")),1)]),_:1},8,["loading"])):V("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),r(z,{modelValue:a.value,"onUpdate:modelValue":n[7]||(n[7]=f=>a.value=f),"max-width":"400px"},{default:o(()=>[r(R,null,{default:o(()=>[r(S,null,{default:o(()=>[p(v(e.$t("apiKey.remove")),1)]),_:1}),r(q,null,{default:o(()=>[p(v(e.$t("apiKey.confirmRemove")),1)]),_:1}),r(j,null,{default:o(()=>[r(T),r(A,{variant:"text",onClick:n[6]||(n[6]=f=>a.value=!1)},{default:o(()=>[p(v(e.$t("apiKey.cancel")),1)]),_:1}),r(A,{color:"error",variant:"flat",loading:C(k),onClick:Y},{default:o(()=>[p(v(e.$t("apiKey.remove")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),he=se(_e,[["__scopeId","data-v-663f0e48"]]);export{he as default};
