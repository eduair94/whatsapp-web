import{k,A as H,a3 as V,x as j,f as i,l as z,u as q}from"./BNTQV3vS.js";const p=i(!1),c=i(null),o=i(!1),E=i(0),x=i(null),f=i(null),v=i(!1),m=i(!1),O=(g={})=>{const{includeAuth:y=!0,retryAttempts:T=2,timeout:C=3e4}=g,{user:h}=k();let l=null;try{H()&&(l=V.useReCaptcha())}catch{console.warn("reCaptcha not available in current context")}const F=async()=>{try{if(!l){console.warn("reCaptcha instance not available");return}return await(l==null?void 0:l.recaptchaLoaded()),await(l==null?void 0:l.executeRecaptcha("wp"))}catch(e){console.error("Failed to get reCAPTCHA token:",e);return}},b=async()=>{if(!y||!h.value)return null;try{return await h.value.getIdToken()}catch(e){throw console.error("Failed to get Firebase auth token:",e),new Error("Authentication failed")}},$=e=>{m.value=e},I=(e,t)=>{const r=`/api/phone/${e}`,n=new URLSearchParams;t&&n.append("token",t);const u=n.toString();return u?`${r}?${u}`:r},A=async(e,t=1)=>{var r,n,u,a,L,P;try{const{$api:s}=q(),w=await R();return(await Promise.race([s.get(e,{headers:w}),new Promise((G,D)=>setTimeout(()=>D(new Error("Request timeout")),C))])).data}catch(s){if(((r=s.response)==null?void 0:r.status)===429)throw o.value=!0,new Error("Rate limit exceeded. Please try again later.");if(((n=s.response)==null?void 0:n.status)===401)throw new Error("Authentication failed. Please log in again.");if(((u=s.response)==null?void 0:u.status)===403)throw window.location.href="/api/refresh",new Error("Access forbidden. Please refresh the page.");if(((a=s.response)==null?void 0:a.status)>=500&&t<T)return console.warn(`API request failed (attempt ${t}), retrying...`),await new Promise(w=>setTimeout(w,1e3*t)),A(e,t+1);throw(P=(L=s.response)==null?void 0:L.data)!=null&&P.message?new Error(s.response.data.message):s.message==="Request timeout"?new Error("Request timed out. Please try again."):new Error("Failed to fetch profile data. Please try again.")}},K=async e=>{if(c.value=null,o.value=!1,!e||e.trim().length===0)return c.value="Phone number is required",{data:null,loading:!1,error:c.value,rateLimited:!1};p.value=!0;try{const t=await F(),r=I(e,t),n=await A(r);return E.value=Date.now(),d(),{data:n,loading:!1,error:null,rateLimited:!1}}catch(t){return c.value=t.message||"An unexpected error occurred",console.error("Phone API error:",t),d(),{data:null,loading:!1,error:c.value,rateLimited:o.value}}finally{p.value=!1}},M=()=>{c.value=null,o.value=!1},S=j(()=>!y||!!h.value),U=()=>{if(!o.value)return 0;const t=Date.now()-E.value;return Math.max(0,3e3-t)},R=async()=>({Authorization:`Bearer ${await b()}`,"Content-Type":"application/json"}),d=async()=>{var e;v.value=!0;try{const{$api:t}=q(),{waitForLoadingFirebase:r}=k();await r();const n="/api/phone/limits",u=await R(),a=(await t.get(n,{headers:u})).data;return a.success&&a.limits&&(x.value=a.limits,a.apiKeyLimits?f.value=a.apiKeyLimits:f.value=null,m.value=a.hasApiKey||!1,m.value&&f.value&&f.value.requestRemaining!==void 0?o.value=f.value.requestRemaining<=0:m.value&&!f.value?o.value=!1:o.value=a.limits.remaining<=0),a}catch(t){return console.error("Failed to fetch rate limit info:",t),((e=t.response)==null?void 0:e.status)===403&&(window.location.href="/api/refresh"),null}finally{v.value=!1}};return{loading:p,error:c,rateLimited:o,isAuthenticated:S,rateLimitInfo:x,rateLimitInfoApi:f,rateLimitLoading:v,hasApiKey:m,setApiKeyValue:$,searchProfile:K,clearError:M,getRateLimitTimeRemaining:U,fetchRateLimitInfo:d,startRateLimitMonitoring:(e=3e4)=>{d(),z(h,t=>{d()},{immediate:!0})},options:i(g)}};export{O as u};
