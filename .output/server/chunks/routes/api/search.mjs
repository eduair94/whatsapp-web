import{d as e,h as t,l as r,g as o,k as n,j as i}from"../../_/nitro.mjs";import s from"axios";import{I as a}from"../../_/ipRateLimiterService.mjs";import"fs";import"os";import"path";import"url";import"http";import"https";import"events";import"zlib";import"@fastify/busboy";import"jsonwebtoken";import"node-forge";import"crypto";import"jwks-rsa";import"bcryptjs";import"mongoose";import"lru-cache";import"@unocss/core";import"@unocss/preset-wind3";import"devalue";import"consola";import"unhead";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"node:fs";import"node:url";import"unhead/server";import"unhead/plugins";import"unhead/utils";import"vue-bundle-renderer/runtime";import"vue/server-renderer";import"node:path";import"node:crypto";const p=new a(!0,"IpRequest_search");p.RATE_LIMIT=20,p.WINDOW=6e4;const u=e((async e=>{var a,u,d;try{if(!(await t(e)).success)return r(e,401),{success:!1,error:"Authentication required. Please sign in to access the database.",statusCode:401,authRequired:!0};const a=function(e){var t,r,o,n,i,s,a,p;const u=function(e){var t,r;return(null==(r=null==(t=e.node)?void 0:t.req)?void 0:r.headers)||e.headers}(e)||{};return(null==(r=null==(t=u["x-forwarded-for"])?void 0:t.split(",")[0])?void 0:r.trim())||u["x-real-ip"]||u["x-client-ip"]||u["cf-connecting-ip"]||(null==(i=null==(n=null==(o=e.node)?void 0:o.req)?void 0:n.connection)?void 0:i.remoteAddress)||(null==(p=null==(a=null==(s=e.node)?void 0:s.req)?void 0:a.socket)?void 0:p.remoteAddress)||"unknown"}(e)||"unknown";if(!await p.checkRateLimit(a)){const t=await p.getRequestCount(a);return r(e,429),{success:!1,error:"Rate limit exceeded. Please try again later.",statusCode:429,rateLimit:{limit:t.max,current:t.count,restartsIn:t.restartsIn}}}const u=o(e),d=parseInt(u.page)||1,c=parseInt(u.limit)||10,m=u.number,l=u.countryCode,h=u.hasProfilePic,f=u.isBusiness,v=u.dateFrom,g=u.dateTo,w="true"===u.includeCount,b=u.search,y=new URLSearchParams;d&&y.append("page",d.toString()),c&&y.append("limit",c.toString()),m&&y.append("number",m),l&&y.append("countryCode",l),h&&y.append("hasProfilePic",h),f&&y.append("isBusiness",f),v&&y.append("dateFrom",v),g&&y.append("dateTo",g),w&&y.append("includeCount","true"),b&&y.append("search",b);const q=y.toString();if(n(e,"Cache-Control","max-age=60, s-maxage=60"),n(e,"Vary","Accept-Encoding, Accept-Language, X-Forwarded-For"),q){const t=Buffer.from(q).toString("base64");n(e,"ETag",`"${t}"`);if(i(e,"if-none-match")===`"${t}"`)return r(e,304),null}const C=`http://104.234.204.107:3728/phone-numbers/search?${y.toString()}`,I=await s.get(C);return await p.incrementSuccessfulRequest(a),I.data}catch(e){return console.error("Search API request failed:",e),{success:!1,error:(null==(u=null==(a=e.response)?void 0:a.data)?void 0:u.message)||"Search request failed",statusCode:(null==(d=e.response)?void 0:d.status)||500}}}));export{u as default};
//# sourceMappingURL=search.mjs.map
