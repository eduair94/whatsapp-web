import{defineComponent as e,ref as a,watch as l,resolveComponent as t,unref as i,isRef as r,withCtx as o,createTextVNode as n,createVNode as u,toDisplayString as d,createBlock as s,createCommentVNode as c,openBlock as v,withModifiers as p,readonly as m,useSSRContext as y}from"vue";import{ssrRenderAttrs as f,ssrRenderComponent as $,ssrInterpolate as K}from"vue/server-renderer";import{g as b,k as _,l as g,b as h}from"./server.mjs";import{Q as x}from"./usePhoneApi-CzJFK_0x.mjs";import{s as C}from"./_plugin-vue_export-helper-DlAUqK2U.mjs";import"../_/nitro.mjs";import"fs";import"os";import"path";import"url";import"http";import"https";import"events";import"zlib";import"@fastify/busboy";import"jsonwebtoken";import"node-forge";import"crypto";import"jwks-rsa";import"bcryptjs";import"mongoose";import"lru-cache";import"@unocss/core";import"@unocss/preset-wind3";import"devalue";import"consola";import"unhead";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:url";import"unhead/server";import"unhead/plugins";import"unhead/utils";import"vue-bundle-renderer/runtime";import"node:path";import"node:crypto";import"vue-router";import"@unhead/addons";import"@unhead/schema-org/vue";import"axios";import"vue-recaptcha-v3";import"idb";const w=e({__name:"ApiKeyManager",__ssrInlineRender:!0,setup(e){const{t:y}=b(),{user:C}=_(),{loading:w,error:A,linkApiKey:V,getUserApiKey:P,removeApiKey:U}=(()=>{const{$api:e}=h(),l=a(!1),t=a(null),k=async e=>{try{return await e.getIdToken()}catch(e){throw console.error("Failed to get Firebase ID token:",e),new Error("Authentication failed. Please sign in again.")}},G=async e=>({Authorization:`Bearer ${await k(e)}`,"Content-Type":"application/json"});return{loading:m(l),error:m(t),linkApiKey:async(a,i)=>{var r,o;l.value=!0,t.value=null;try{const l=await G(a);return(await e.post("/api/user/api-key",{apiKey:i.trim()},{headers:l})).data}catch(e){const a=(null==(o=null==(r=e.response)?void 0:r.data)?void 0:o.error)||"Failed to link API key";throw t.value=a,new Error(a)}finally{l.value=!1}},getUserApiKey:async a=>{var i,r;l.value=!0,t.value=null;try{const l=await G(a);return(await e.get("/api/user/api-key",{headers:l})).data}catch(e){const a=(null==(r=null==(i=e.response)?void 0:i.data)?void 0:r.error)||"Failed to get API key";throw t.value=a,new Error(a)}finally{l.value=!1}},getFullApiKey:async a=>{var i,r;l.value=!0,t.value=null;try{const l=await G(a);return(await e.get("/api/user/api-key?full=true",{headers:l})).data}catch(e){const a=(null==(r=null==(i=e.response)?void 0:i.data)?void 0:r.error)||"Failed to get API key";throw t.value=a,new Error(a)}finally{l.value=!1}},removeApiKey:async a=>{var i,r;l.value=!0,t.value=null;try{const l=await G(a);return(await e.delete("/api/user/api-key",{headers:l})).data}catch(e){const a=(null==(r=null==(i=e.response)?void 0:i.data)?void 0:r.error)||"Failed to remove API key";throw t.value=a,new Error(a)}finally{l.value=!1}},validateApiKey:e=>{if(!e||"string"!=typeof e)return{isValid:!1,error:"API key is required"};const a=e.trim();return a.length<20?{isValid:!1,error:"API key must be at least 20 characters long"}:a.length>200?{isValid:!1,error:"API key is too long (maximum 200 characters)"}:{isValid:!0}},checkAuthentication:e=>!!e||(t.value="You must be signed in to manage API keys",!1)}})(),{isApiKeyManagerOpen:j,closeApiKeyManager:z}=g(),{setApiKeyValue:I}=x(),R=a(!1),q=a(!1),S=a(""),E=a(null),L=a(),D=a(null),M=a(null),T=[e=>!!e||y("apiKey.validation.required"),e=>e.length>=20||y("apiKey.validation.invalid")],W=e=>new Date(e).toLocaleDateString(),fe=async()=>{if(C.value)try{const e=await P(C.value);e.hasKey&&(E.value={apiKey:e.apiKey,linkedAt:e.lastSaved},I(!0))}catch(e){console.error("Error loading API key:",e)}},F=async()=>{var e;if(!C.value)return void(D.value=y("auth.error.notAuthenticated"));const{valid:a}=await(null==(e=L.value)?void 0:e.validate());if(a)try{D.value=null,M.value=null;const e=await V(C.value,S.value);e.success?(M.value=y("apiKey.success"),S.value="",q.value=!1,await fe()):D.value=e.error||y("apiKey.error")}catch(e){D.value=e.message||y("apiKey.error")}},ae=async()=>{if(C.value)try{D.value=null,M.value=null;const e=await U(C.value);e.success?(M.value=e.message,E.value=null,R.value=!1):D.value=e.error||y("apiKey.error")}catch(e){D.value=e.message||y("apiKey.error")}},le=()=>{z(),q.value=!1,S.value="",D.value=null,M.value=null,R.value=!1};return l(C,(async e=>{e?await fe():E.value=null}),{immediate:!0}),l(A,(e=>{e&&(D.value=e)})),(e,a,l,m)=>{const y=t("v-dialog"),b=t("v-card"),_=t("v-card-title"),g=t("v-icon"),h=t("v-card-text"),x=t("v-alert"),C=t("v-btn"),A=t("v-form"),V=t("v-text-field"),P=t("v-card-actions"),U=t("v-spacer");a(`<div${f(m)} data-v-663f0e48>`),a($(y,{modelValue:i(j),"onUpdate:modelValue":e=>r(j)?j.value=e:null,"max-width":"600px",persistent:""},{default:o(((a,l,t,r)=>{if(!l)return[u(b,null,{default:o((()=>[u(_,{class:"d-flex align-center"},{default:o((()=>[u(g,{class:"mr-2",color:"primary"},{default:o((()=>[n("mdi-key-variant")])),_:1}),n(" "+d(e.$t("apiKey.title")),1)])),_:1}),u(h,null,{default:o((()=>[u("p",{class:"mb-4 text-body-2"},d(e.$t("apiKey.description")),1),D.value?(v(),s(x,{key:0,type:"error",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>D.value=null},{default:o((()=>[n(d(D.value),1)])),_:1},8,["onClick:close"])):c("",!0),M.value?(v(),s(x,{key:1,type:"success",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>M.value=null},{default:o((()=>[n(d(M.value),1)])),_:1},8,["onClick:close"])):c("",!0),E.value&&!q.value?(v(),s("div",{key:2,class:"mb-4"},[u(b,{variant:"outlined",class:"pa-3"},{default:o((()=>[u("div",{class:"d-flex align-center justify-space-between"},[u("div",null,[u("div",{class:"text-subtitle-2 mb-1"},d(e.$t("apiKey.current")),1),u("div",{class:"text-body-2 font-mono"},d(E.value.apiKey),1),u("div",{class:"text-caption text-medium-emphasis"},d(e.$t("auth.linkedAt"))+": "+d(W(E.value.linkedAt)),1)]),u("div",{class:"d-flex flex-column gap-2"},[u(C,{size:"small",color:"primary",variant:"outlined",onClick:e=>q.value=!0},{default:o((()=>[n(d(e.$t("apiKey.update")),1)])),_:1},8,["onClick"]),u(C,{size:"small",color:"error",variant:"outlined",onClick:e=>R.value=!0},{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1},8,["onClick"])])])])),_:1})])):c("",!0),!E.value||q.value?(v(),s("div",{key:3},[u(A,{ref_key:"formRef",ref:L,onSubmit:p(F,["prevent"])},{default:o((()=>[u(V,{modelValue:S.value,"onUpdate:modelValue":e=>S.value=e,label:e.$t("apiKey.inputLabel"),placeholder:e.$t("apiKey.inputPlaceholder"),variant:"outlined",type:"password","prepend-inner-icon":"mdi-key",rules:T,loading:i(w),class:"mb-3",required:""},null,8,["modelValue","onUpdate:modelValue","label","placeholder","loading"])])),_:1},512)])):c("",!0)])),_:1}),u(P,{class:"pa-4"},{default:o((()=>[u(U),u(C,{variant:"text",onClick:le,disabled:i(w)},{default:o((()=>[n(d(e.$t("apiKey.cancel")),1)])),_:1},8,["disabled"]),!E.value||q.value?(v(),s(C,{key:0,color:"primary",variant:"flat",loading:i(w),onClick:F},{default:o((()=>[n(d(e.$t("apiKey.save")),1)])),_:1},8,["loading"])):c("",!0)])),_:1})])),_:1})];l($(b,null,{default:o(((a,l,t,r)=>{if(!l)return[u(_,{class:"d-flex align-center"},{default:o((()=>[u(g,{class:"mr-2",color:"primary"},{default:o((()=>[n("mdi-key-variant")])),_:1}),n(" "+d(e.$t("apiKey.title")),1)])),_:1}),u(h,null,{default:o((()=>[u("p",{class:"mb-4 text-body-2"},d(e.$t("apiKey.description")),1),D.value?(v(),s(x,{key:0,type:"error",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>D.value=null},{default:o((()=>[n(d(D.value),1)])),_:1},8,["onClick:close"])):c("",!0),M.value?(v(),s(x,{key:1,type:"success",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>M.value=null},{default:o((()=>[n(d(M.value),1)])),_:1},8,["onClick:close"])):c("",!0),E.value&&!q.value?(v(),s("div",{key:2,class:"mb-4"},[u(b,{variant:"outlined",class:"pa-3"},{default:o((()=>[u("div",{class:"d-flex align-center justify-space-between"},[u("div",null,[u("div",{class:"text-subtitle-2 mb-1"},d(e.$t("apiKey.current")),1),u("div",{class:"text-body-2 font-mono"},d(E.value.apiKey),1),u("div",{class:"text-caption text-medium-emphasis"},d(e.$t("auth.linkedAt"))+": "+d(W(E.value.linkedAt)),1)]),u("div",{class:"d-flex flex-column gap-2"},[u(C,{size:"small",color:"primary",variant:"outlined",onClick:e=>q.value=!0},{default:o((()=>[n(d(e.$t("apiKey.update")),1)])),_:1},8,["onClick"]),u(C,{size:"small",color:"error",variant:"outlined",onClick:e=>R.value=!0},{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1},8,["onClick"])])])])),_:1})])):c("",!0),!E.value||q.value?(v(),s("div",{key:3},[u(A,{ref_key:"formRef",ref:L,onSubmit:p(F,["prevent"])},{default:o((()=>[u(V,{modelValue:S.value,"onUpdate:modelValue":e=>S.value=e,label:e.$t("apiKey.inputLabel"),placeholder:e.$t("apiKey.inputPlaceholder"),variant:"outlined",type:"password","prepend-inner-icon":"mdi-key",rules:T,loading:i(w),class:"mb-3",required:""},null,8,["modelValue","onUpdate:modelValue","label","placeholder","loading"])])),_:1},512)])):c("",!0)])),_:1}),u(P,{class:"pa-4"},{default:o((()=>[u(U),u(C,{variant:"text",onClick:le,disabled:i(w)},{default:o((()=>[n(d(e.$t("apiKey.cancel")),1)])),_:1},8,["disabled"]),!E.value||q.value?(v(),s(C,{key:0,color:"primary",variant:"flat",loading:i(w),onClick:F},{default:o((()=>[n(d(e.$t("apiKey.save")),1)])),_:1},8,["loading"])):c("",!0)])),_:1})];l($(_,{class:"d-flex align-center"},{default:o(((a,l,t,i)=>{if(!l)return[u(g,{class:"mr-2",color:"primary"},{default:o((()=>[n("mdi-key-variant")])),_:1}),n(" "+d(e.$t("apiKey.title")),1)];l($(g,{class:"mr-2",color:"primary"},{default:o(((e,a,l,t)=>{if(!a)return[n("mdi-key-variant")];a("mdi-key-variant")})),_:1},t,i)),l(` ${K(e.$t("apiKey.title"))}`)})),_:1},t,r)),l($(h,null,{default:o(((a,l,t,r)=>{if(!l)return[u("p",{class:"mb-4 text-body-2"},d(e.$t("apiKey.description")),1),D.value?(v(),s(x,{key:0,type:"error",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>D.value=null},{default:o((()=>[n(d(D.value),1)])),_:1},8,["onClick:close"])):c("",!0),M.value?(v(),s(x,{key:1,type:"success",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>M.value=null},{default:o((()=>[n(d(M.value),1)])),_:1},8,["onClick:close"])):c("",!0),E.value&&!q.value?(v(),s("div",{key:2,class:"mb-4"},[u(b,{variant:"outlined",class:"pa-3"},{default:o((()=>[u("div",{class:"d-flex align-center justify-space-between"},[u("div",null,[u("div",{class:"text-subtitle-2 mb-1"},d(e.$t("apiKey.current")),1),u("div",{class:"text-body-2 font-mono"},d(E.value.apiKey),1),u("div",{class:"text-caption text-medium-emphasis"},d(e.$t("auth.linkedAt"))+": "+d(W(E.value.linkedAt)),1)]),u("div",{class:"d-flex flex-column gap-2"},[u(C,{size:"small",color:"primary",variant:"outlined",onClick:e=>q.value=!0},{default:o((()=>[n(d(e.$t("apiKey.update")),1)])),_:1},8,["onClick"]),u(C,{size:"small",color:"error",variant:"outlined",onClick:e=>R.value=!0},{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1},8,["onClick"])])])])),_:1})])):c("",!0),!E.value||q.value?(v(),s("div",{key:3},[u(A,{ref_key:"formRef",ref:L,onSubmit:p(F,["prevent"])},{default:o((()=>[u(V,{modelValue:S.value,"onUpdate:modelValue":e=>S.value=e,label:e.$t("apiKey.inputLabel"),placeholder:e.$t("apiKey.inputPlaceholder"),variant:"outlined",type:"password","prepend-inner-icon":"mdi-key",rules:T,loading:i(w),class:"mb-3",required:""},null,8,["modelValue","onUpdate:modelValue","label","placeholder","loading"])])),_:1},512)])):c("",!0)];l(`<p class="mb-4 text-body-2" data-v-663f0e48${r}>${K(e.$t("apiKey.description"))}</p>`),D.value?l($(x,{type:"error",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>D.value=null},{default:o(((e,a,l,t)=>{if(!a)return[n(d(D.value),1)];a(`${K(D.value)}`)})),_:1},t,r)):l("\x3c!----\x3e"),M.value?l($(x,{type:"success",variant:"tonal",class:"mb-4",closable:"","onClick:close":e=>M.value=null},{default:o(((e,a,l,t)=>{if(!a)return[n(d(M.value),1)];a(`${K(M.value)}`)})),_:1},t,r)):l("\x3c!----\x3e"),E.value&&!q.value?(l(`<div class="mb-4" data-v-663f0e48${r}>`),l($(b,{variant:"outlined",class:"pa-3"},{default:o(((a,l,t,i)=>{if(!l)return[u("div",{class:"d-flex align-center justify-space-between"},[u("div",null,[u("div",{class:"text-subtitle-2 mb-1"},d(e.$t("apiKey.current")),1),u("div",{class:"text-body-2 font-mono"},d(E.value.apiKey),1),u("div",{class:"text-caption text-medium-emphasis"},d(e.$t("auth.linkedAt"))+": "+d(W(E.value.linkedAt)),1)]),u("div",{class:"d-flex flex-column gap-2"},[u(C,{size:"small",color:"primary",variant:"outlined",onClick:e=>q.value=!0},{default:o((()=>[n(d(e.$t("apiKey.update")),1)])),_:1},8,["onClick"]),u(C,{size:"small",color:"error",variant:"outlined",onClick:e=>R.value=!0},{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1},8,["onClick"])])])];l(`<div class="d-flex align-center justify-space-between" data-v-663f0e48${i}><div data-v-663f0e48${i}><div class="text-subtitle-2 mb-1" data-v-663f0e48${i}>${K(e.$t("apiKey.current"))}</div><div class="text-body-2 font-mono" data-v-663f0e48${i}>${K(E.value.apiKey)}</div><div class="text-caption text-medium-emphasis" data-v-663f0e48${i}>${K(e.$t("auth.linkedAt"))}: ${K(W(E.value.linkedAt))}</div></div><div class="d-flex flex-column gap-2" data-v-663f0e48${i}>`),l($(C,{size:"small",color:"primary",variant:"outlined",onClick:e=>q.value=!0},{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.update")),1)];l(`${K(e.$t("apiKey.update"))}`)})),_:1},t,i)),l($(C,{size:"small",color:"error",variant:"outlined",onClick:e=>R.value=!0},{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.remove")),1)];l(`${K(e.$t("apiKey.remove"))}`)})),_:1},t,i)),l("</div></div>")})),_:1},t,r)),l("</div>")):l("\x3c!----\x3e"),!E.value||q.value?(l(`<div data-v-663f0e48${r}>`),l($(A,{ref_key:"formRef",ref:L,onSubmit:F},{default:o(((a,l,t,r)=>{if(!l)return[u(V,{modelValue:S.value,"onUpdate:modelValue":e=>S.value=e,label:e.$t("apiKey.inputLabel"),placeholder:e.$t("apiKey.inputPlaceholder"),variant:"outlined",type:"password","prepend-inner-icon":"mdi-key",rules:T,loading:i(w),class:"mb-3",required:""},null,8,["modelValue","onUpdate:modelValue","label","placeholder","loading"])];l($(V,{modelValue:S.value,"onUpdate:modelValue":e=>S.value=e,label:e.$t("apiKey.inputLabel"),placeholder:e.$t("apiKey.inputPlaceholder"),variant:"outlined",type:"password","prepend-inner-icon":"mdi-key",rules:T,loading:i(w),class:"mb-3",required:""},null,t,r))})),_:1},t,r)),l("</div>")):l("\x3c!----\x3e")})),_:1},t,r)),l($(P,{class:"pa-4"},{default:o(((a,l,t,r)=>{if(!l)return[u(U),u(C,{variant:"text",onClick:le,disabled:i(w)},{default:o((()=>[n(d(e.$t("apiKey.cancel")),1)])),_:1},8,["disabled"]),!E.value||q.value?(v(),s(C,{key:0,color:"primary",variant:"flat",loading:i(w),onClick:F},{default:o((()=>[n(d(e.$t("apiKey.save")),1)])),_:1},8,["loading"])):c("",!0)];l($(U,null,null,t,r)),l($(C,{variant:"text",onClick:le,disabled:i(w)},{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.cancel")),1)];l(`${K(e.$t("apiKey.cancel"))}`)})),_:1},t,r)),!E.value||q.value?l($(C,{color:"primary",variant:"flat",loading:i(w),onClick:F},{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.save")),1)];l(`${K(e.$t("apiKey.save"))}`)})),_:1},t,r)):l("\x3c!----\x3e")})),_:1},t,r))})),_:1},t,r))})),_:1},l)),a($(y,{modelValue:R.value,"onUpdate:modelValue":e=>R.value=e,"max-width":"400px"},{default:o(((a,l,t,r)=>{if(!l)return[u(b,null,{default:o((()=>[u(_,null,{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1}),u(h,null,{default:o((()=>[n(d(e.$t("apiKey.confirmRemove")),1)])),_:1}),u(P,null,{default:o((()=>[u(U),u(C,{variant:"text",onClick:e=>R.value=!1},{default:o((()=>[n(d(e.$t("apiKey.cancel")),1)])),_:1},8,["onClick"]),u(C,{color:"error",variant:"flat",loading:i(w),onClick:ae},{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1},8,["loading"])])),_:1})])),_:1})];l($(b,null,{default:o(((a,l,t,r)=>{if(!l)return[u(_,null,{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1}),u(h,null,{default:o((()=>[n(d(e.$t("apiKey.confirmRemove")),1)])),_:1}),u(P,null,{default:o((()=>[u(U),u(C,{variant:"text",onClick:e=>R.value=!1},{default:o((()=>[n(d(e.$t("apiKey.cancel")),1)])),_:1},8,["onClick"]),u(C,{color:"error",variant:"flat",loading:i(w),onClick:ae},{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1},8,["loading"])])),_:1})];l($(_,null,{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.remove")),1)];l(`${K(e.$t("apiKey.remove"))}`)})),_:1},t,r)),l($(h,null,{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.confirmRemove")),1)];l(`${K(e.$t("apiKey.confirmRemove"))}`)})),_:1},t,r)),l($(P,null,{default:o(((a,l,t,r)=>{if(!l)return[u(U),u(C,{variant:"text",onClick:e=>R.value=!1},{default:o((()=>[n(d(e.$t("apiKey.cancel")),1)])),_:1},8,["onClick"]),u(C,{color:"error",variant:"flat",loading:i(w),onClick:ae},{default:o((()=>[n(d(e.$t("apiKey.remove")),1)])),_:1},8,["loading"])];l($(U,null,null,t,r)),l($(C,{variant:"text",onClick:e=>R.value=!1},{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.cancel")),1)];l(`${K(e.$t("apiKey.cancel"))}`)})),_:1},t,r)),l($(C,{color:"error",variant:"flat",loading:i(w),onClick:ae},{default:o(((a,l,t,i)=>{if(!l)return[n(d(e.$t("apiKey.remove")),1)];l(`${K(e.$t("apiKey.remove"))}`)})),_:1},t,r))})),_:1},t,r))})),_:1},t,r))})),_:1},l)),a("</div>")}}}),A=w.setup;w.setup=(e,a)=>{const l=y();return(l.modules||(l.modules=new Set)).add("components/ApiKeyManager.vue"),A?A(e,a):void 0};const V=C(w,[["__scopeId","data-v-663f0e48"]]);export{V as default};
//# sourceMappingURL=ApiKeyManager-DXkNJiLJ.mjs.map
