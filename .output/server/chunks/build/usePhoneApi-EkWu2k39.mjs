import{getCurrentInstance as e,computed as t,ref as a,watch as r}from"vue";import{useReCaptcha as n}from"vue-recaptcha-v3";import{k as o,b as i}from"./server.mjs";const l=a(!1),s=a(null),c=a(!1),d=a(0),m=a(null),h=a(null),v=a(!1),p=a(!1),X=(g={})=>{const{includeAuth:f=!0,retryAttempts:y=2,timeout:P=3e4}=g,{user:A}=o();let L=null;try{e()&&(L=n())}catch{console.warn("reCaptcha not available in current context")}const q=async()=>{if(!f||!A.value)return null;try{return await A.value.getIdToken()}catch(e){throw console.error("Failed to get Firebase auth token:",e),new Error("Authentication failed")}},w=async(e,t=1)=>{var a,r,n,o,l,s;try{const{$api:t}=i(),a={...await $(),"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache","SW-Bypass":"true"};return(await Promise.race([t.get(e,{headers:a}),new Promise(((e,t)=>setTimeout((()=>t(new Error("Request timeout"))),P)))])).data}catch(i){if(429===(null==(a=i.response)?void 0:a.status))throw c.value=!0,new Error("Rate limit exceeded. Please try again later.");if(401===(null==(r=i.response)?void 0:r.status))throw new Error("Authentication failed. Please log in again.");if(403===(null==(n=i.response)?void 0:n.status))throw(void 0).location.href="/api/refresh",new Error("Access forbidden. Please refresh the page.");if((null==(o=i.response)?void 0:o.status)>=500&&t<y)return console.warn(`API request failed (attempt ${t}), retrying...`),await new Promise((e=>setTimeout(e,1e3*t))),w(e,t+1);throw null!=(s=null==(l=i.response)?void 0:l.data)&&s.message?new Error(i.response.data.message):"Request timeout"===i.message?new Error("Request timed out. Please try again."):new Error("Failed to fetch profile data. Please try again.")}},R=t((()=>!f||!!A.value)),$=async()=>({Authorization:`Bearer ${await q()}`,"Content-Type":"application/json"}),u=async()=>null;return{loading:l,error:s,rateLimited:c,isAuthenticated:R,rateLimitInfo:m,rateLimitInfoApi:h,rateLimitLoading:v,hasApiKey:p,setApiKeyValue:e=>{p.value=e},searchProfile:async e=>{if(s.value=null,c.value=!1,!e||0===e.trim().length)return s.value="Phone number is required",{data:null,loading:!1,error:s.value,rateLimited:!1};l.value=!0;try{const t=await(async()=>{try{return L?(await(null==L?void 0:L.recaptchaLoaded()),await(null==L?void 0:L.executeRecaptcha("wp"))):void console.warn("reCaptcha instance not available")}catch(e){return void console.error("Failed to get reCAPTCHA token:",e)}})(),a=((e,t)=>{const a=`/api/phone/${e}`,r=new URLSearchParams;t&&r.append("token",t);const n=r.toString();return n?`${a}?${n}`:a})(e,t),r=await w(a);return d.value=Date.now(),u(),{data:r,loading:!1,error:null,rateLimited:!1}}catch(e){return s.value=e.message||"An unexpected error occurred",console.error("Phone API error:",e),u(),{data:null,loading:!1,error:s.value,rateLimited:c.value}}finally{l.value=!1}},clearError:()=>{s.value=null,c.value=!1},getRateLimitTimeRemaining:()=>{if(!c.value)return 0;const e=Date.now()-d.value;return Math.max(0,3e3-e)},fetchRateLimitInfo:u,startRateLimitMonitoring:(e=3e4)=>{u(),r(A,(e=>{u()}),{immediate:!0})},options:a(g)}};export{X};
//# sourceMappingURL=usePhoneApi-EkWu2k39.mjs.map
