import{getCurrentInstance as e,computed as r,ref as t,watch as a}from"vue";import{useReCaptcha as o}from"vue-recaptcha-v3";import{k as n,b as i}from"./server.mjs";const s=t(!1),c=t(null),u=t(!1),d=t(0),h=t(null),m=t(null),p=t(!1),w=t(!1),Q=(f={})=>{const{includeAuth:g=!0,retryAttempts:P=2,timeout:A=3e4}=f,{user:L}=n();let E=null;try{e()&&(E=o())}catch{console.warn("reCaptcha not available in current context")}const q=async()=>{if(!g||!L.value)return null;try{return await L.value.getIdToken()}catch(e){throw console.error("Failed to get Firebase auth token:",e),new Error("Authentication failed")}},v=async(e,r=1)=>{var t,a,o,n,s,c;try{const{$api:r}=i(),t={...await y(),"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache","SW-Bypass":"true"};return(await Promise.race([r.get(e,{headers:t}),new Promise(((e,r)=>setTimeout((()=>r(new Error("Request timeout"))),A)))])).data}catch(i){if(429===(null==(t=i.response)?void 0:t.status))throw u.value=!0,new Error("Rate limit exceeded. Please try again later.");if(401===(null==(a=i.response)?void 0:a.status))throw new Error("Authentication failed. Please log in again.");if(403===(null==(o=i.response)?void 0:o.status)){if(1!==r)throw(void 0).location.href="/api/refresh",new Error("Access forbidden. Please refresh the page.");console.warn("403 error encountered, retrying with service worker bypass");try{const r={...await y(),"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache","SW-Bypass":"true","X-Bypass-Cache":"true"},t=await fetch(e,{method:"GET",headers:r,cache:"no-store"});if(t.ok)return await t.json();throw(void 0).location.href="/api/refresh",new Error("Access forbidden. Please refresh the page.")}catch(e){throw console.error("Direct fetch also failed:",e),(void 0).location.href="/api/refresh",new Error("Access forbidden. Please refresh the page.")}}if((null==(n=i.response)?void 0:n.status)>=500&&r<P)return console.warn(`API request failed (attempt ${r}), retrying...`),await new Promise((e=>setTimeout(e,1e3*r))),v(e,r+1);throw null!=(c=null==(s=i.response)?void 0:s.data)&&c.message?new Error(i.response.data.message):"Request timeout"===i.message?new Error("Request timed out. Please try again."):new Error("Failed to fetch profile data. Please try again.")}},C=r((()=>!g||!!L.value)),y=async()=>({Authorization:`Bearer ${await q()}`,"Content-Type":"application/json"}),l=async()=>null;return{loading:s,error:c,rateLimited:u,isAuthenticated:C,rateLimitInfo:h,rateLimitInfoApi:m,rateLimitLoading:p,hasApiKey:w,setApiKeyValue:e=>{w.value=e},searchProfile:async e=>{if(c.value=null,u.value=!1,!e||0===e.trim().length)return c.value="Phone number is required",{data:null,loading:!1,error:c.value,rateLimited:!1};s.value=!0;try{const r=await(async()=>{try{return E?(await(null==E?void 0:E.recaptchaLoaded()),await(null==E?void 0:E.executeRecaptcha("wp"))):void console.warn("reCaptcha instance not available")}catch(e){return void console.error("Failed to get reCAPTCHA token:",e)}})(),t=((e,r)=>{const t=`/api/phone/${e}`,a=new URLSearchParams;r&&a.append("token",r);const o=a.toString();return o?`${t}?${o}`:t})(e,r),a=await v(t);return d.value=Date.now(),l(),{data:a,loading:!1,error:null,rateLimited:!1}}catch(e){return c.value=e.message||"An unexpected error occurred",console.error("Phone API error:",e),l(),{data:null,loading:!1,error:c.value,rateLimited:u.value}}finally{s.value=!1}},clearError:()=>{c.value=null,u.value=!1},getRateLimitTimeRemaining:()=>{if(!u.value)return 0;const e=Date.now()-d.value;return Math.max(0,3e3-e)},fetchRateLimitInfo:l,startRateLimitMonitoring:(e=3e4)=>{l(),a(L,(e=>{l()}),{immediate:!0})},options:t(f)}};export{Q};
//# sourceMappingURL=usePhoneApi-CzJFK_0x.mjs.map
